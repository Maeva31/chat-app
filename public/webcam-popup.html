<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Webcam distante</title>
</head>
<body style="margin:0; background:#000; display:flex;justify-content:center;align-items:center;height:100vh;">
  <video id="remote-video" autoplay playsinline style="max-width:100%; max-height:100%; border-radius:8px; border:2px solid #ccc;"></video>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const remoteUsername = urlParams.get('user');
    const socket = io();

    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let pc = null;

    async function start() {
      pc = new RTCPeerConnection(config);

      pc.ontrack = event => {
        const video = document.getElementById('remote-video');
        if (video.srcObject !== event.streams[0]) {
          video.srcObject = event.streams[0];
          console.log('Flux distant reçu');
        }
      };

      pc.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('signal', { to: remoteUsername, data: { candidate: event.candidate } });
        }
      };

      socket.on('signal', async ({ from, data }) => {
        if (from !== remoteUsername) return;

        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('signal', { to: from, data: { sdp: pc.localDescription } });
          }
        } else if (data.candidate) {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch (e) {
            console.error('Erreur ICE candidate:', e);
          }
        }
      });

      // Demande au serveur d’initier la connexion WebRTC vers remoteUsername
      socket.emit('request call', { to: remoteUsername });
    }

    start();
  </script>
</body>
</html>
