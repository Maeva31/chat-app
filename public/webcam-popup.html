<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Webcam Popup</title>
  <style>
    body {
      margin: 0; background: #000;
      display: flex; justify-content: center; align-items: center; height: 100vh;
    }
    video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      border: 2px solid #ccc;
      background: black;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Récupère le paramètre user cible dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const targetUser = urlParams.get('user');
    const myUsername = localStorage.getItem('username');

    const videoElem = document.getElementById('video');
    let localStream = null;
    let pc = null;

    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    async function startLocalWebcam() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoElem.srcObject = localStream;

        // Optionnel : préviens serveur que webcam est active
        socket.emit('webcam status', { username: myUsername, active: true });
      } catch (e) {
        alert("Impossible d'accéder à la webcam : " + e.message);
      }
    }

    async function startRemoteWebcam() {
      pc = new RTCPeerConnection(config);

      pc.ontrack = (event) => {
        videoElem.srcObject = event.streams[0];
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('signal', {
            to: targetUser,
            from: myUsername,
            data: { candidate: event.candidate }
          });
        }
      };

      // Demande au serveur d'initier l'appel WebRTC
      socket.emit('call user', { to: targetUser, from: myUsername });

      socket.on('signal', async ({ from, data }) => {
        if (from !== targetUser) return;

        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));

          if (data.sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            socket.emit('signal', {
              to: from,
              from: myUsername,
              data: { sdp: pc.localDescription }
            });
          }
        } else if (data.candidate) {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch (err) {
            console.error('Erreur ajout ICE candidate:', err);
          }
        }
      });
    }

    // Démarre la webcam locale ou distante selon l'utilisateur
    if (targetUser === myUsername) {
      startLocalWebcam();
    } else {
      startRemoteWebcam();
    }

    window.addEventListener('beforeunload', () => {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      if (pc) pc.close();
    });
  </script>
</body>
</html>
