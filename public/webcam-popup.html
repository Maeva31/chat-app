<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Webcam distante</title>
</head>
<body style="margin:0; background:#000; display:flex;justify-content:center;align-items:center;height:100vh;">
  <video id="remote-video" autoplay playsinline style="max-width:100%; max-height:100%; border-radius:8px; border:2px solid #ccc;"></video>

  <script src="/socket.io/socket.io.js"></script>
  <video id="remote-video" autoplay playsinline></video>
<script src="/socket.io/socket.io.js"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const remoteUsername = urlParams.get('user');
  const socket = io();
  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
  let pc = null;
  const myUsername = localStorage.getItem('username');

  async function start() {
    pc = new RTCPeerConnection(config);

    pc.ontrack = e => {
      document.getElementById('remote-video').srcObject = e.streams[0];
    };

    pc.onicecandidate = e => {
      if (e.candidate) {
        socket.emit('signal', { to: remoteUsername, from: myUsername, data: { candidate: e.candidate } });
      }
    };

    socket.on('signal', async ({ from, data }) => {
      if (from !== remoteUsername) return;
      if (data.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if (data.sdp.type === 'offer') {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit('signal', { to: from, from: myUsername, data: { sdp: pc.localDescription } });
        }
      } else if (data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    });

    // Demande au serveur d'initier le call
    socket.emit('request call', { to: remoteUsername });
  }

  start();
</script>

</body>
</html>
